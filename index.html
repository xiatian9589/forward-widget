<!DOCTYPE html>
<html>
<head>
  <title>Matrix Forward Message Widget</title>
  <meta charset="UTF-8" />
  <style>
    body { font-family: sans-serif; padding: 1em; }
    #messages { margin-top: 1em; }
    .message { border-bottom: 1px solid #ccc; padding: 0.5em 0; }
    button { margin-left: 1em; }
  </style>
</head>
<body>
  <h1>Forward Message Widget</h1>
  <div id="messages">Loading messages...</div>

  <!-- Load legacy Matrix Widget API -->
  <script src="https://unpkg.com/matrix-widget-api@1.13.1/dist/api.min.js"></script>

  <script>
    const widgetId = null; // Let the host determine it
    const api = new WidgetApi(widgetId);

    api.requestCapabilities([
      "org.matrix.msc2876.send_event",
      "org.matrix.msc2876.receive_event",
      "org.matrix.msc2876.send_message"
    ]);

    api.on("action:org.matrix.msc2876.timeline_event", (ev) => {
      const event = ev.detail.data;
      if (event.type === "m.room.message" && event.content?.body) {
        displayMessage(event.sender, event.content.body);
      }
      api.transport.reply(ev.detail, {}); // acknowledge receipt
    });

    api.start();
    api.sendContentLoaded();

    const container = document.getElementById("messages");
    container.innerHTML = "<em>Waiting for messages...</em>";

    function displayMessage(sender, body) {
      const div = document.createElement("div");
      div.className = "message";
      div.innerHTML = `<strong>${sender}</strong>: ${body} <button>Forward</button>`;
      div.querySelector("button").onclick = async () => {
        const content = {
          msgtype: "m.text",
          body: `Forwarded from ${sender}: ${body}`
        };
        await api.sendEvent("m.room.message", content);
        alert("Message forwarded!");
      };
      container.appendChild(div);
    }
  </script>
</body>
</html>
