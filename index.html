<!DOCTYPE html>
<html>
<head>
  <title>Matrix Forward Message Widget</title>
  <meta charset="UTF-8" />
  <script src="https://unpkg.com/matrix-widget-api"></script>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    #messages { margin-top: 1em; }
    .message { border-bottom: 1px solid #ccc; padding: 0.5em 0; }
    button { margin-left: 1em; }
  </style>
</head>
<body>
  <h1>Forward Message Widget</h1>
  <div id="messages">Loading messages...</div>

  <script>
    const widgetApi = new MatrixWidgetApi.WidgetApi();

    // Start communication with the host
    widgetApi.requestCapabilities([
      "org.matrix.msc2876.send_event",
      "org.matrix.msc2876.receive_event",
      "org.matrix.msc2876.get_event",
      "org.matrix.msc2876.send_message"
    ]);
    widgetApi.start();

    async function fetchAndDisplayMessages() {
      const roomId = await widgetApi.getRoomId();
      const myUserId = await widgetApi.getUserId();

      const timeline = await widgetApi.receiveSingleStateEvent("m.room.message", "");
      const events = await widgetApi.readEvents();

      const container = document.getElementById("messages");
      container.innerHTML = "";

      const textMessages = events.filter(e => e.type === "m.room.message" && e.content.body);

      textMessages.reverse().slice(0, 10).forEach(event => {
        const div = document.createElement("div");
        div.className = "message";
        const sender = event.sender;
        const body = event.content.body;

        div.innerHTML = `<strong>${sender}</strong>: ${body} <button>Forward</button>`;

        div.querySelector("button").onclick = async () => {
          const content = {
            msgtype: "m.text",
            body: `Forwarded from ${sender}: ${body}`
          };
          await widgetApi.sendRoomEvent("m.room.message", content);
          alert("Message forwarded!");
        };

        container.appendChild(div);
      });
    }

    fetchAndDisplayMessages().catch(console.error);
  </script>
</body>
</html>
